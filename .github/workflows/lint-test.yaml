name: Lint and Test Charts

on:
  pull_request:
    paths:
      - 'charts/**'
      - '.github/workflows/lint-test.yaml'
  push:
    branches:
      - master
      - main
    paths:
      - 'charts/**'
      - '.github/workflows/lint-test.yaml'

jobs:
  lint:
    name: Lint Helm Charts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          check-latest: true

      - name: Set up chart-testing
        uses: helm/chart-testing-action@v2.6.1

      - name: Run chart-testing (list-changed)
        id: list-changed
        run: |
          changed=$(ct list-changed --target-branch ${{ github.event.repository.default_branch }})
          if [[ -n "$changed" ]]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Run chart-testing (lint)
        if: steps.list-changed.outputs.changed == 'true'
        run: ct lint --target-branch ${{ github.event.repository.default_branch }} --check-version-increment=false

      - name: Run Helm lint
        run: |
          for chart in charts/*/; do
            helm lint "$chart"
          done

  template-validation:
    name: Template Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Install kubeval
        run: |
          wget https://github.com/instrumenta/kubeval/releases/latest/download/kubeval-linux-amd64.tar.gz
          tar xf kubeval-linux-amd64.tar.gz
          sudo mv kubeval /usr/local/bin
          rm kubeval-linux-amd64.tar.gz

      - name: Template charts
        run: |
          for chart in charts/*/; do
            echo "Templating $chart..."
            helm template test "$chart" --set globalpingToken=test-token > /tmp/template-output.yaml
            kubeval --strict --ignore-missing-schemas /tmp/template-output.yaml
          done

      - name: Template with all options
        run: |
          helm template test charts/globalping-probe/ \
            --set globalpingToken=test-token \
            --set deploymentType=deployment \
            --set replicaCount=3 \
            --set persistence.enabled=true \
            --set networkPolicy.enabled=true \
            --set monitoring.enabled=true \
            --set monitoring.serviceMonitor.enabled=true \
            > /tmp/full-template.yaml
          kubeval --strict --ignore-missing-schemas /tmp/full-template.yaml

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: 'charts/'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  install-test:
    name: Install Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          check-latest: true

      - name: Set up chart-testing
        uses: helm/chart-testing-action@v2.6.1

      - name: Create kind cluster
        uses: helm/kind-action@v1.9.0
        with:
          cluster_name: kind
          kubectl_version: v1.29.2
          wait: 120s

      - name: Run chart-testing (install)
        run: |
          ct install \
            --target-branch ${{ github.event.repository.default_branch }} \
            --charts charts/globalping-probe \
            --helm-extra-set-args "--set=globalpingToken=test-token-for-ci"

      - name: Verify DaemonSet deployment
        run: |
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=globalping-probe --timeout=300s || true
          kubectl get daemonset -A
          kubectl get pods -A
          kubectl describe pod -l app.kubernetes.io/name=globalping-probe

      - name: Check logs
        if: always()
        run: |
          kubectl logs -l app.kubernetes.io/name=globalping-probe --tail=100 || true

  documentation-check:
    name: Documentation Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check README exists
        run: |
          for chart in charts/*/; do
            if [ ! -f "$chart/README.md" ]; then
              echo "ERROR: README.md not found in $chart"
              exit 1
            fi
          done

      - name: Check Chart.yaml completeness
        run: |
          for chart in charts/*/Chart.yaml; do
            echo "Checking $chart..."
            # Check for required fields
            grep -q "name:" "$chart" || (echo "Missing name in $chart" && exit 1)
            grep -q "version:" "$chart" || (echo "Missing version in $chart" && exit 1)
            grep -q "description:" "$chart" || (echo "Missing description in $chart" && exit 1)
            grep -q "maintainers:" "$chart" || (echo "Missing maintainers in $chart" && exit 1)
          done

      - name: Verify values.yaml documented
        run: |
          # Check that major configuration options are mentioned in README
          for chart_dir in charts/*/; do
            readme="$chart_dir/README.md"
            values="$chart_dir/values.yaml"
            
            if [ -f "$readme" ] && [ -f "$values" ]; then
              echo "Verifying documentation for $chart_dir..."
              # Extract some key values and check they're documented
              if grep -q "globalpingToken:" "$values"; then
                grep -q "globalpingToken" "$readme" || (echo "globalpingToken not documented" && exit 1)
              fi
            fi
          done

  test-values-combinations:
    name: Test Value Combinations
    runs-on: ubuntu-latest
    strategy:
      matrix:
        test-case:
          - name: "daemonset-default"
            values: "--set deploymentType=daemonset --set globalpingToken=test"
          - name: "deployment-mode"
            values: "--set deploymentType=deployment --set replicaCount=2 --set globalpingToken=test"
          - name: "with-persistence"
            values: "--set persistence.enabled=true --set globalpingToken=test"
          - name: "with-network-policy"
            values: "--set networkPolicy.enabled=true --set globalpingToken=test"
          - name: "without-hostnetwork"
            values: "--set network.hostNetwork=false --set network.dnsPolicy=ClusterFirst --set globalpingToken=test"
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Test template rendering - ${{ matrix.test-case.name }}
        run: |
          echo "Testing: ${{ matrix.test-case.name }}"
          helm template test charts/globalping-probe/ ${{ matrix.test-case.values }} > /tmp/output.yaml
          
          # Basic validation that output is valid YAML
          cat /tmp/output.yaml | grep -q "apiVersion:" || (echo "Invalid template output" && exit 1)
          
          echo "âœ… Template rendered successfully"

